name: Build DEB on Version Tag

on:
  push:
    tags:
      - '*'

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x ./jpackage-to-deb.sh

      - name: Get version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Delete old deb files
        run: find . -name "*.deb" -type f -delete

      - name: Build DEB
        run: |
          ./jpackage-to-deb.sh "calculator" "${{ steps.version.outputs.version }}"

      - name: Verify DEB exists
        run: |
          find . -name "*.deb" -ls

      # ðŸ‘‡ CLONE TARGET REPO
      - name: Clone linux-java-debs repo
        run: |
          git clone https://x-access-token:${{ secrets.PUSH_TOKEN }}@github.com/ahansantra/linux-java-debs.git

      # ðŸ‘‡ COPY DEB INTO IT
      - name: Copy DEB files
        run: |
          cp **/*.deb linux-java-debs/

      # ðŸ‘‡ COMMIT & PUSH
      - name: Commit and push DEB
        run: |
          cd linux-java-debs
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add *.deb
          git commit -m "Add calculator ${{ steps.version.outputs.version }} DEB"
          git push
