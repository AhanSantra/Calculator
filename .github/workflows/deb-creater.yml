name: Build DEB on Version Tag

on:
  push:
    tags:
      - '*'

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x ./jpackage-to-deb.sh

      - name: Get version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Delete old deb files
        run: find . -name "*.deb" -type f -delete

      - name: Build DEB
        run: |
          ./jpackage-to-deb.sh "calculator" "${{ steps.version.outputs.version }}"

      - name: Verify DEB exists
        run: |
          ls dists

      - name: Clone linux-java-debs repo
        run: |
          git clone https://x-access-token:${{ secrets.PUSH_TOKEN }}@github.com/ahansantra/linux-java-debs.git
          ls -lah linux-java-debs

      - name: Copy deb files (DEBUG)
        run: |
          echo "==== FINDING DEB FILES ===="
          ls
          find . -name "*.deb" -ls

          echo "==== COPYING ===="
          cp "$(find . -maxdepth 1 -name "*.deb" -printf "%f\n")" linux-java-debs/

          echo "==== TARGET DIR CONTENTS ===="
          ls -lah linux-java-debs

      - name: Commit and push (DEBUG)
        run: |
          cd linux-java-debs

          git status
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add .
          git status

          git commit -m "Add calculator ${{ steps.version.outputs.version }} DEB" || echo "⚠️ NOTHING TO COMMIT"

          git branch
          git push origin HEAD || echo "❌ PUSH FAILED"

